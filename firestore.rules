rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Allow public read (get) access to individual product documents.
    match /products/{productId} {
      allow get: if true;
      allow write: if isSignedIn();
    }
    
    // Allow public list access for the entire products collection.
    // This is crucial for homepage and shop page queries.
    match /products {
        allow list: if true;
    }

    /**
     * @description Restricts access to user-specific data.
     * Enforces document ownership for all data under a user's path.
     */
    match /users/{userId}/{document=**} {
      allow read, write: if isOwner(userId);
    }
    
    /**
     * @description Allows admins to query across all 'orders' collections.
     * This is useful for an admin panel to view all orders in the system.
     */
    match /{path=**}/orders/{orderId} {
      allow list: if isSignedIn();
    }


    // --- Helper Functions ---

    /**
     * @description Checks if the user is signed in.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the authenticated user is the owner of the document.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }
  }
}
