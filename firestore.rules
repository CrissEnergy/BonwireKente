
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- Public Collections ---

    /**
     * @description Public read access for the 'products' collection.
     * @path /products
     * @allow (list, get) Public read access for all users.
     */
    match /products/{productId} {
      allow get: if true;
      allow list: if true;
      allow write: if isSignedIn();
    }


    // --- User-Specific Data ---

    /**
     * @description Restricts access to user-specific data.
     * @path /users/{userId}
     * @principle Enforces document ownership for all user data.
     */
    match /users/{userId}/{document=**} {
      allow read, write: if isOwner(userId);
    }
    
    // --- Collection Group Rules ---
    
    /**
     * @description Allows admins to query across all 'orders' collections.
     * We assume an admin role would be checked here in a real app.
     * @path /users/{userId}/orders/{orderId}
     * @allow (list) Signed-in users can list all orders for the admin panel.
     */
    match /{path=**}/orders/{orderId} {
      allow list: if isSignedIn();
    }


    // --- Helper Functions ---

    /**
     * @description Checks if the user is signed in.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the authenticated user is the owner of the document.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }
  }
}
